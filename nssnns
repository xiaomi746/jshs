local Players = cloneref(game:GetService("Players"))
local RunService = cloneref(game:GetService("RunService"))
local ReplicatedStorage = cloneref(game:GetService("ReplicatedStorage"))

local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character
local Humanoid = Character and Character:FindFirstChildOfClass("Humanoid")
local HumanoidRootPart = Character and Character:FindFirstChild("HumanoidRootPart")

LocalPlayer.CharacterAdded:Connect(function(char)
    Character = char
    HumanoidRootPart = char:WaitForChild("HumanoidRootPart")
    Humanoid = char:WaitForChild("Humanoid")
end)

-- UI
local WindUI = loadstring(game:HttpGet("https://raw.githubusercontent.com/454244513/WindUIFix/refs/heads/main/main.lua"))()
local Window = WindUI:CreateWindow({
    Title = "Moon Lua Ohio",
    Author = "moonlua.icu",
    OpenButton = {
        Title = "Moon Lua Ohio",
        CornerRadius = UDim.new(0, 16),
        StrokeThickness = 3,
        Color = ColorSequence.new(Color3.fromHex("f9a8d4"), Color3.fromHex("f9a8d4")),
        OnlyMobile = false,
        Enabled = true,
        Draggable = true,
        Scale = 0.5,
    },
})

local BladeTab = Window:Tab({
    Title = "Blade",
})
BladeTab:Select()

BladeTab:Paragraph({
    Title = "moonlua.icu",
    Desc = "Official Discord",
})

BladeTab:Paragraph({
    Title = "Free & Open Source",
    Desc = "Don't buy this script",
})

-- Blade Aura Toggle
local bladeaura = false
BladeTab:Toggle({
    Title = "Blade Aura",
    Callback = function(state)
        bladeaura = state
    end,
})

-- Blade System
local load = require(ReplicatedStorage.devv).load
local Signal = load("Signal")
local FireServer = Signal.FireServer
local InvokeServer = Signal.InvokeServer
local GUID = load("GUID")
local v3item = load("v3item")
local Raycast = load("Raycast")
local inventory = v3item.inventory

getgenv().throwargs = nil

local function hackthrow(plr, itemname, itemguid, velocity, epos)
    if plr ~= LocalPlayer then return end
    task.spawn(function()
        local throwGuid = GUID()
        local success, stickyId = InvokeServer("throwSticky", throwGuid, itemname, itemguid, velocity, epos)
        if not success then return end

        local dummyPart = Instance.new("Part")
        dummyPart.Size = Vector3.new(2,2,2)
        dummyPart.Position = epos
        dummyPart.Anchored = true
        dummyPart.Transparency = 1
        dummyPart.CanCollide = true
        dummyPart.Parent = workspace

        local rayParams = RaycastParams.new()
        rayParams.FilterType = Enum.RaycastFilterType.Blacklist
        rayParams.FilterDescendantsInstances = {plr.Character, workspace.Game.Local, workspace.Game.Drones}
        local dist = (epos - plr.Character.Head.Position).Magnitude
        local rayResult = workspace:Raycast(
            plr.Character.Head.Position,
            (epos - plr.Character.Head.Position).Unit * (dist + 5),
            rayParams
        )

        if rayResult and rayResult.Instance then
            local hitPart = rayResult.Instance
            local relativeHitCFrame = hitPart.CFrame:ToObjectSpace(CFrame.new(rayResult.Position, rayResult.Position + rayResult.Normal))
            local stickyCFrame = CFrame.new(rayResult.Position)
            dummyPart:Destroy()

            getgenv().throwargs = {
                "hitSticky",
                stickyId or throwGuid,
                hitPart,
                relativeHitCFrame,
                stickyCFrame,
            }
            InvokeServer("hitSticky", stickyId or throwGuid, hitPart, relativeHitCFrame, stickyCFrame)
        else
            dummyPart:Destroy()
        end
    end)
end

local function getinventory()
    return inventory.items
end

local function finditem(string)
    for guid, data in next, getinventory() do
        if data.name == string or data.type == string or data.subtype == string then
            return data
        end
    end
end

local function executebladekill(plr, head)
    local item = finditem("Ninja Star")
    if item then
        FireServer("equip", item.guid)

        if not getgenv().throwargs then
            local spos = LocalPlayer.Character.RightHand.Position
            local epos = head.Position
            local velocity = (epos - spos).Unit * ((spos - epos).Magnitude * 15)
            task.spawn(InvokeServer, "attemptPurchaseAmmo", "Ninja Star")
            hackthrow(LocalPlayer, "Ninja Star", item.guid, velocity, epos)
        end

        if getgenv().throwargs then
            getgenv().throwargs[3] = head
            task.spawn(InvokeServer, unpack(getgenv().throwargs))
        end
    else
        task.spawn(InvokeServer, "attemptPurchase", "Ninja Star")
    end
end

-- Heartbeat Loop
RunService.Heartbeat:Connect(function()
    if bladeaura and HumanoidRootPart then
        for _, plr in ipairs(Players:GetPlayers()) do
            if plr == LocalPlayer then continue end
            local char = plr.Character
            local hum = char and char:FindFirstChildOfClass("Humanoid")
            local head = char and char:FindFirstChild("Head")
            if hum and hum.Health > 0 and head then
                local dist = (HumanoidRootPart.Position - head.Position).Magnitude
                if dist < 190 then
                    executebladekill(plr, head)
                    break
                end
            end
        end
    end
end)
